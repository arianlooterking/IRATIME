<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IRATIME</title>
  <style>
    body{font-family:system-ui, sans-serif;background:#0b0b0b;color:#eee;margin:0;padding:0;}
    main{max-width:600px;margin:0 auto;padding:16px;}
    .card{background:#141414;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px;}
    input,button{width:100%;padding:12px;margin:4px 0;border-radius:8px;border:1px solid #333;background:#1e1e1e;color:#eee;}
    button{cursor:pointer;}
    .row{display:flex;gap:8px;}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:8px;display:none;}
    #last{font-size:0.9em;color:#bbb;margin-top:8px;}
  </style>
</head>
<body>
<main>
  <section class="card">
    <h2>Register Device</h2>
    <input id="name" placeholder="Full name">
    <input id="phone" placeholder="Phone (optional)">
    <button id="register">Register / Link</button>
    <div class="muted">Device ID: <span id="dev"></span></div>
  </section>
  <section class="card">
    <h2>Actions</h2>
    <p id="hint"></p>
    <div class="row">
      <button data-ev="check-in">Check in</button>
      <button data-ev="break-start">Break start</button>
      <button data-ev="break-end">Break end</button>
      <button data-ev="check-out">Check out</button>
    </div>
    <div id="last"></div>
  </section>
</main>
<div id="toast"></div>
<script>
const devId = localStorage.getItem('tg_device_uuid') || crypto.randomUUID();
localStorage.setItem('tg_device_uuid', devId);
document.getElementById('dev').textContent = devId;
let CFG = {};
fetch('/api/config').then(r=>r.json()).then(c=>{CFG=c; if(!c.skip_geofence) document.getElementById('hint').textContent='Location required';});
function toast(msg, ok=true){const t=document.getElementById('toast');t.textContent=msg;t.style.background=ok?'#333':'#a33';t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
async function register(){
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const res=await fetch('/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,phone,platform:navigator.userAgent,device_uuid:devId})});
  const j=await res.json();
  toast(res.ok?'Registered':(j.error||'Error'),res.ok);
}
async function sendEvent(type){
  let coords=null;
  try{coords=await new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(p=>resolve(p.coords),reject,{enableHighAccuracy:true,timeout:5000}));}
  catch(e){if(!CFG.skip_geofence){toast('Location required',false);return;}}
  const body={device_uuid:devId,source:'ui'};
  if(coords){body.lat=coords.latitude;body.lon=coords.longitude;}
  const res=await fetch('/api/events/'+type,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j=await res.json();
  if(res.ok){toast('Done',true);const ev=j.event;document.getElementById('last').textContent=`${ev.type} @ ${ev.latitude||'?'} , ${ev.longitude||'?'} IP ${ev.public_ip||''}`;}
  else toast(j.error||'Error',false);
}

document.getElementById('register').onclick=register;
document.querySelectorAll('button[data-ev]').forEach(b=>b.onclick=()=>sendEvent(b.dataset.ev));
</script>
</body>
</html>
