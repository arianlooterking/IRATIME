<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TimeGuard — Employee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    async function postJSON(path, body) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      try { return { status: res.status, json: JSON.parse(txt) }; }
      catch { return { status: res.status, json: { raw: txt } }; }
    }

    const Status = ({ message, type }) => {
      if (!message) return null;
      const color = type === 'error' ? 'text-red-400' : 'text-green-400';
      return <p className={color}>{message}</p>;
    };

    const RegistrationForm = ({ devId }) => {
      const [name, setName] = useState('');
      const [phone, setPhone] = useState('');
      const [status, setStatus] = useState(null);

      const register = async () => {
        if (!name.trim()) {
          setStatus({ message: 'Name is required', type: 'error' });
          return;
        }
        const res = await postJSON('/api/auth/register', {
          name: name.trim(),
          phone: phone.trim(),
          platform: navigator.userAgent,
          device_uuid: devId
        });
        setStatus(
          res.status === 200
            ? { message: 'Registered', type: 'ok' }
            : { message: res.json.error || res.status, type: 'error' }
        );
      };

      return (
        <div className="p-4 border border-gray-700 rounded-lg mb-4">
          <div className="flex flex-col sm:flex-row gap-2 mb-2">
            <input
              className="flex-1 p-2 bg-gray-800 rounded"
              placeholder="Full name"
              value={name}
              onChange={e => setName(e.target.value)}
            />
            <input
              className="flex-1 p-2 bg-gray-800 rounded"
              placeholder="Phone (optional)"
              value={phone}
              onChange={e => setPhone(e.target.value)}
            />
          </div>
          <div className="flex items-center gap-2 mb-2">
            <button
              className="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500"
              onClick={register}
            >
              Register / Link Device
            </button>
            <span className="text-sm text-gray-400">
              Device: <code>{devId}</code>
            </span>
          </div>
          <Status {...status} />
        </div>
      );
    };

    const EventButtons = ({ devId }) => {
      const [status, setStatus] = useState(null);

      const sendEvent = async endpoint => {
        const res = await postJSON('/api/events/' + endpoint, {
          device_uuid: devId,
          source: 'manual'
        });
        setStatus(
          res.status === 200
            ? { message: endpoint + ' recorded', type: 'ok' }
            : { message: res.json.error || res.status, type: 'error' }
        );
      };

      return (
        <div className="p-4 border border-gray-700 rounded-lg">
          <p className="text-sm text-gray-400 mb-2">
            Wi-Fi allow-list only (no location). Must be on shop Wi-Fi if PUBLIC_IPS is set.
          </p>
          <div className="flex flex-wrap gap-2 mb-2">
            <button
              className="px-4 py-2 bg-green-600 rounded hover:bg-green-500"
              onClick={() => sendEvent('check-in')}
            >
              Check In
            </button>
            <button
              className="px-4 py-2 bg-yellow-600 rounded hover:bg-yellow-500"
              onClick={() => sendEvent('break-start')}
            >
              Break Start
            </button>
            <button
              className="px-4 py-2 bg-yellow-600 rounded hover:bg-yellow-500"
              onClick={() => sendEvent('break-end')}
            >
              Break End
            </button>
            <button
              className="px-4 py-2 bg-red-600 rounded hover:bg-red-500"
              onClick={() => sendEvent('check-out')}
            >
              Check Out
            </button>
          </div>
          <Status {...status} />
        </div>
      );
    };

    const App = () => {
      const devId = useMemo(() => {
        const id = localStorage.getItem('tg_device_uuid') || crypto.randomUUID();
        localStorage.setItem('tg_device_uuid', id);
        return id;
      }, []);

      return (
        <main className="max-w-xl mx-auto p-4">
          <h1 className="text-xl font-bold mb-4">TimeGuard — Employee</h1>
          <RegistrationForm devId={devId} />
          <EventButtons devId={devId} />
        </main>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>

